# ArgoCD Server-Config (bleibt wie gehabt)
server:
  # ... deine bestehende Config

# ConfigMap für ArgoCD (WICHTIG für Health Checks)
configs:
  cm:
    # Custom Health Check für Argo Rollouts
    resource.customizations.health.argoproj.io_Rollout: |
      hs = {}
      if obj.status ~= nil then
        if obj.status.phase ~= nil then
          if obj.status.phase == "Healthy" then
            hs.status = "Healthy"
            hs.message = obj.status.message
          elseif obj.status.phase == "Paused" then
            hs.status = "Suspended"
            hs.message = "Rollout is paused"
          elseif obj.status.phase == "Progressing" then
            hs.status = "Progressing"
            hs.message = "Rollout is progressing"
          elseif obj.status.phase == "Degraded" then
            hs.status = "Degraded"
            hs.message = obj.status.message
          else
            hs.status = "Unknown"
            hs.message = "Rollout phase: " .. obj.status.phase
          end
        else
          hs.status = "Progressing"
          hs.message = "Waiting for rollout to start"
        end
      else
        hs.status = "Progressing"
        hs.message = "Waiting for rollout status"
      end
      return hs

    # PRODUKTIV: Global ignoriere Rollouts-Controller-Änderungen
    resource.customizations.ignoreDifferences.all: |
      managedFieldsManagers:
        - argo-rollouts
        - rollouts-controller
    
    # PRODUKTIV: Ignoriere CRD Webhook CABundle (wird zur Laufzeit generiert)
    resource.customizations.ignoreDifferences.apiextensions.k8s.io_CustomResourceDefinition: |
      jqPathExpressions:
        - .spec.conversion.webhook.clientConfig.caBundle

# Subchart bleibt wie gehabt
argo-rollouts:
  installCRDs: true
  keepCRDs: true
  clusterInstall: true
  createClusterAggregateRoles: true

  controller:
    replicas: 1
    metrics:
      enabled: true

  dashboard:
    enabled: true
    service:
      type: ClusterIP
      port: 3100
