services:
  # Image 1: k3s (Kubernetes Cluster)
  k3s-server:
    image: rancher/k3s:v1.28.0
    command: server --disable=traefik --disable=servicelb
    environment:
      K3S_TOKEN: mytoken
      K3S_KUBECONFIG_OUTPUT: /output/kubeconfig.yaml
      K3S_KUBECONFIG_MODE: "666"
    volumes:
      - k3s-server:/var/lib/rancher/k3s
      - ./kubeconfig:/output
    ports:
      - "6443:6443"
    privileged: true
    restart: unless-stopped

  # Image 2: toolbox (kubectl + helm)
  toolbox:
    image: dtzar/helm-kubectl:3.13.0
    container_name: acme-toolbox
    depends_on:
      - k3s-server
    environment:
      KUBECONFIG: /root/.kube/kubeconfig.yaml
    volumes:
      - ./kubeconfig/kubeconfig.yaml:/root/.kube/kubeconfig.yaml:ro
      - ./workspace:/workspace
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: sleep infinity
    restart: unless-stopped

  # Image 3: Crossplane (nur cachen)
  crossplane-image:
    image: crossplane/crossplane:v1.18.2
    command: echo "crossplane image cached"
    restart: "no"

  # Image 4: Kubernetes Dashboard GUI
  dashboard:
    image: kubernetesui/dashboard:v2.7.0
    container_name: k3s-dashboard
    depends_on:
      - k3s-server
    ports:
      - "8443:8443"
    volumes:
      - ./kubeconfig/kubeconfig.yaml:/etc/kubernetes/admin.conf:ro
    command:
      - "--kubeconfig=/etc/kubernetes/admin.conf"
      - "--insecure-bind-address=0.0.0.0"
      - "--port=8443"
    restart: unless-stopped

volumes:
  k3s-server: {}